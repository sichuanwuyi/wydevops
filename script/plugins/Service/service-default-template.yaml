{{- range \$.Values.${t_moduleName}.containers }}

  {{- if and .service .service.clusterIP }}
  {{- with .service.clusterIP }}
---
apiVersion: ${t_apiVersion}
kind: Service
metadata:
  namespace: {{ \$.Release.Namespace }}
  name: {{ .name | trunc 53 | trimSuffix \"-\" }}-clusterip
  labels:
    helm.sh/chart: ${gCurrentChartName}-${gCurrentChartVersion}
    app.kubernetes.io/version: ${gCurrentChartVersion}
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: {{ .name | trunc 53 | trimSuffix \"-\" }}
    app.kubernetes.io/instance: {{ \$.Release.Name }}
spec:
  {{- if and .headless (eq .headless true) }}
  # 核心：无头服务，解析带序号的Pod DNS
  clusterIP: None
  # StatefulSet必备：解析未就绪Pod（主从选举/初始化必备）
  publishNotReadyAddresses: true
  {{- else }}
  type: ClusterIP
  {{- end }}
  ports:
    {{- toYaml .ports | nindent 4 }}
  selector:
    app: {{ \$.Values.${t_moduleName}.serviceSelector }}

  {{- end }}
  {{- end }}

  {{- if and .service .service.nodePort }}
  {{- with .service.nodePort }}
---
apiVersion: ${t_apiVersion}
kind: Service
metadata:
  namespace: {{ \$.Release.Namespace }}
  name: {{ .name | trunc 54 | trimSuffix \"-\" }}-nodeport
  labels:
    helm.sh/chart: ${gCurrentChartName}-${gCurrentChartVersion}
    app.kubernetes.io/version: ${gCurrentChartVersion}
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: {{ .name | trunc 54 | trimSuffix \"-\" }}-nodeport
    app.kubernetes.io/instance: {{ \$.Release.Name }}
spec:
  type: NodePort
  ports:
    {{- toYaml .ports | nindent 4 }}
  selector:
    app: {{ \$.Values.${t_moduleName}.serviceSelector }}

  {{- end }}
  {{- end }}

{{- end }}