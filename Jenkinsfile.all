pipeline {
  agent { label "${AGENT_LABEL}"}
  environment {
        AGENT_LABEL = 'maven1'
        JENKINS_SCRIPT = '${BUILD_SCRIPT_ROOT}/wydevops.sh'
        //此处填入从Gitee拉取源码时使用的用户ID
        GITHUB_USER_ID = '924b45239b2ef132f34d03d671865767'
  }

  parameters {
      string(name: 'GIT_PROJECT_NAME', defaultValue: 'java-sample', description: 'gitee仓库名')
      //GITHUB_GROUP的取值由Gitee仓库决定。
      choice(name: 'GITHUB_GROUP', choices: ['tmt_china'], description: 'checkout git group')
      choice(name: 'GITHUB_BRANCH', choices: ['master', 'develop'], description: 'checkout git branch')
      choice(name: 'JOB_LANGUAGE', choices: ['java', 'golang', 'c++', 'python', 'shell', 'vue'], description: '')
      choice(name: 'ARCH_TYPES', choices: ['undefine', 'linux/amd64,linux/arm64', 'linux/amd64', 'linux/arm64'], description: '架构类型')
      choice(name: 'BUILD_TYPE', choices: ['single', 'double', 'base', 'business'], description: '构建类型')
      //AGENT_LABEL取值由Jenkins各节点的标签决定。
      string(name: 'AGENT_LABEL', defaultValue: 'maven1', description: 'agent label')
      string(name: 'BUILD_PATH', defaultValue: './', description: '执行编译的路径')
  }

  stages {
    stage('Checkout') {
        options {
            timeout(time: 2, unit: 'MINUTES')
        }
        steps {
            dir("${GIT_PROJECT_NAME}") {
                echo "----Checkout----"
                git credentialsId: "${GITHUB_USER_ID}", url: "https://gitee.com/${GITHUB_GROUP}/${GIT_PROJECT_NAME}.git", branch: "${GITHUB_BRANCH}".split("/")[-1]
            }
            script{
                currentBuild.result = 'SUCCESS'
                echo "${JOB_LANGUAGE}"
            }
        }
    }

    stage('Build') {
      when {
        allOf{
            expression {currentBuild.result == 'SUCCESS'}
        }
      }
      steps {
        dir("${GIT_PROJECT_NAME}") {
          script {
            catchError {
              echo "Build with ${JENKINS_SCRIPT} ${JOB_LANGUAGE}"
                sh "${JENKINS_SCRIPT} -c -e -d -m -S 'build' -L ${JOB_LANGUAGE} -P ${BUILD_PATH} -B ${BUILD_TYPE} -A ${ARCH_TYPES} -M 'jenkins'"
              }
            }
        }
        script{
            currentBuild.result = 'SUCCESS'
            echo "Build completed"
        }
      }
    }

    stage('Docker') {
      when {
        allOf{
            expression {currentBuild.result == 'SUCCESS'}
        }
      }
      steps {
        dir("${GIT_PROJECT_NAME}") {
            script {
                catchError {
                    sh "${JENKINS_SCRIPT} -e -d -m -S 'docker' -L ${JOB_LANGUAGE} -P ${BUILD_PATH} -B ${BUILD_TYPE} -A ${ARCH_TYPES} -M 'jenkins'"
                }
                echo 'finish creating docker images'
                currentBuild.result = 'SUCCESS'
            }
        }
      }
    }

    stage('Chart') {
     when {
          allOf{
              expression {currentBuild.result == 'SUCCESS'}
          }
      }
      steps {
          dir("${GIT_PROJECT_NAME}") {
              script {
                  catchError {
                      sh "${JENKINS_SCRIPT} -e -d -m -S 'chart' -L ${JOB_LANGUAGE} -P ${BUILD_PATH} -B ${BUILD_TYPE} -A ${ARCH_TYPES} -M 'jenkins'"
                  }
                  echo 'finish creating chart image'
                  currentBuild.result = 'SUCCESS'
              }
          }
      }
    }

    stage('Package') {
        when {
          allOf{
              expression {currentBuild.result == 'SUCCESS'}
          }
        }
        steps {
          dir("${GIT_PROJECT_NAME}") {
              script {
                  catchError {
                      sh "${JENKINS_SCRIPT} -e -d -m -S 'package' -L ${JOB_LANGUAGE} -P ${BUILD_PATH} -B ${BUILD_TYPE} -A ${ARCH_TYPES} -M 'jenkins'"
                  }
                  echo 'finish creating offline package'
                  currentBuild.result = 'SUCCESS'
              }
          }
        }
    }

    stage('Deploy') {
      when {
        allOf{
            expression {currentBuild.result == 'SUCCESS'}
          }
      }
      steps {
        echo "Start deploy application ...${GIT_PROJECT_NAME}"
        dir("${GIT_PROJECT_NAME}") {
            script {
                catchError {
                    sh "${JENKINS_SCRIPT} -e -d -m -S 'deploy' -L ${JOB_LANGUAGE} -P ${BUILD_PATH} -B ${BUILD_TYPE} -A ${ARCH_TYPES} -M 'jenkins'"
                }
                echo 'Deploy completed'
            }
        }
      }
    }
  }
}